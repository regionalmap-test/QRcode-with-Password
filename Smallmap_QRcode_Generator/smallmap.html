function generateSmallMapQRCodesCacheSafe() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("個別区域");
  if (!sheet) {
    Logger.log("シート「個別区域」が見つかりません");
    return;
  }

  const lastRow = sheet.getLastRow();
  const urls = sheet.getRange("D2:D" + lastRow).getValues();       // D列: GitHub Pages URL
  const areaNumbers = sheet.getRange("A2:A" + lastRow).getValues(); // A列: 区域番号

  for (let i = 0; i < urls.length; i++) {
    const baseUrl = urls[i][0];
    const areaNumber = areaNumbers[i][0];

    if (!baseUrl || !areaNumber) continue;

    // キャッシュ回避のためタイムスタンプを URL に追加
    const urlWithTimestamp = baseUrl + "&_t=" + new Date().getTime();

    // QRコード生成用 URL（qrserver.com）
    const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(urlWithTimestamp);

    try {
      const response = UrlFetchApp.fetch(qrUrl);
      const blob = response.getBlob().setName("Map_QRcode_" + areaNumber + ".png");

      // マイドライブ直下に保存
      DriveApp.createFile(blob);
    } catch (e) {
      Logger.log("QRコード生成失敗: " + urlWithTimestamp + " / " + e);
    }

    Utilities.sleep(500); // 安定化のため少し待つ
  }

  SpreadsheetApp.getUi().alert("QRコード生成完了！（マイドライブ直下に保存されました）");
}
